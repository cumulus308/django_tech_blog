{% extends 'layout/app.html' %}

{% block title %} Blog Details {% endblock %}

{% load i18n %}

{% load static %}

{% load safe_content %}


{% block content %}
<div class="blog-page2">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb-main">
                    <h4 class="text-capitalize breadcrumb-title">{% translate "blog-detail" %}</h4>
                    <div class="breadcrumb-action justify-content-center flex-wrap">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <form method="post" action="{% url 'blogs:toggle_bookmark' post.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-info btn-default btn-squared btn-transparent-info ">
                                            {% if is_bookmarked %}
                                                Remove Bookmark
                                            {% else %}
                                                Add Bookmark
                                            {% endif %}
                                        </button>
                                    </form>
                                </li>
                                <li class="breadcrumb-item">
                                    <form method="post" action="{% url 'blogs:toggle_like' post.pk %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-warning btn-default btn-squared btn-transparent-warning ">
                                            {% if is_liked %}
                                                {% translate "Remove Like" %}
                                            {% else %}
                                                {% translate "Add Like" %}
                                            {% endif %}
                                        </button>
                                    </form>
                                </li>
                                {% if user.is_authenticated and user == post.writer %}
                                <li class="breadcrumb-item">
                                    <a href="{% url 'blogs:post_update' post.pk %}" class="btn btn-primary btn-default btn-squared btn-transparent-primary">
                                        {% translate "Edit" %}
                                    </a>
                                </li>

                                    <li class="breadcrumb-item">
                                        <form action="{% url 'blogs:post_delete' post.pk %}" method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-default btn-squared btn-transparent-danger" onclick="return confirm('Are you sure you want to delete this post?');">
                                                {% translate "Delete" %}
                                            </button>
                                        </form>
                                    </li>
                                {% endif %}
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-8 col-12">
                <div class="blog-details-thumbnail">
                    {% if post.thumbnail %}
                        <img src="{{ post.thumbnail.url }}" alt="{{ post.title }}">
                    {% else %}
                        <img src="{% static 'img/blog-details.png' %}">
                    {% endif %}
                </div>
                <article class="blog-details">
                    <div class="blog-details-content">
                        <h1 class="main-title mb-30"> {{ post.title }} </h1>
                        <ul class="blog-details-meta">
                            <li class="blog-author">
                                <a href="#">
                                    <img src="{% static 'img/author-nav1.jpg' %}">
                                </a>
                                <a href="#">
                                    <span> {{ post.writer }} </span>
                                </a>
                            </li>
                            <li class="author-name">
                                <a href="#" rel="bookmark">
                                    <time class="entry-date published updated" > {{post.created_at }} </time>
                                </a>
                            </li>
                            <li class="blog-category">
                                <a href="#" rel="category tag">{{ post.category }}</a>
                            </li>
                            <li class="blog-read-time">8 mins read</li>
                        </ul>
                        <div class="blog-body post-content">
                            {{ post.content | safe_content }}
                        </div>
                        {% comment %} <div class="blog-tags">
                            <ul>
                                <li><a href="#">Design Process</a></li>
                                <li><a href="#">Prototype</a></li>
                                <li><a href="#">Design Process</a></li>
                                <li><a href="#">Prototype</a></li>
                            </ul>
                        </div> {% endcomment %}

                        <div class="blog-author-box media">
                            <div class="auth-img">
                                <img class="w-70" src="{% static 'img/author-nav.jpg' %}" alt="author-nav">
                            </div>
                            <div class="auth-details media-body">
                                <span>Written by</span>
                                <h2>{{post.writer}}</h2>

                                <form method="post" action="{% url 'blogs:toggle_follow' post.writer.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary btn-default btn-squared ">
                                        {% if is_following %}
                                            Unfollow
                                        {% else %}
                                            Follow
                                        {% endif %}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                </article>
                <div class="card card-default card-md mb-4">
                    <div class="card-header py-20">
                        <h6>Usage with list</h6>
                    </div>
                    <div class="card-body">
                        <div class="comment-list">
                            <div class="comment-list__title">
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-3 d-flex align-items-center ">
                                        <textarea class="form-control form-control-lg" name="content" rows="2" placeholder="Write your comment here..." style="resize:none;"></textarea>
                                        <button type="submit" class="btn btn-primary ms-2">Submit</button>
                                    </div>

                                </form>

                            </div>
                            <ul class="comment-list__content">
                                {% for comment in parent_comment %}
                                    <li class="mb-20">
                                        <div class="dm-comment-box media">
                                            <div class="dm-comment-box__author">
                                                <figure>
                                                    <img src="{% static 'img/author/1.jpg' %}" class="bg-opacity-primary d-flex" alt="Admin Autor">
                                                </figure>
                                            </div>
                                            <div class="dm-comment-box__content media-body" id="comment-{{ comment.id }}">
                                                <div class="comment-content-inner cci">
                                                    <span class="cci__author-info">{{ comment.writer }}</span>
                                                    <p class="cci__comment-text comment-content"> {{ comment.content }} </p>
                                                    <div class="cci__comment-actions">
                                                        <a href="#" class="btn-reply reply-comment" data-comment-id="{{ comment.id }}">
                                                            <span>Reply</span>
                                                        </a>
                                                        {% if user.is_authenticated and user == comment.writer %}
                                                        <a href="#" class="btn-reply edit-comment ms-1" data-comment-id="{{ comment.id }}">
                                                            <span>Edit</span>
                                                        </a>
                                                        <form action="{% url 'blogs:comment_delete' comment.pk %}" method="post" style="display: inline;">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn-reply ms-1" style="background: none; border: none; color: inherit; font: inherit; padding: 0; cursor: pointer;">
                                                                <span>Delete</span>
                                                            </button>
                                                        </form>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Replies -->
                                        <ul class="replies-list">
                                            {% for reply in comment.children %}
                                                <li class="mb-20 ml-40">
                                                    <div class="dm-comment-box media">
                                                        <div class="dm-comment-box__content media-body" id="comment-{{ reply.id }}">
                                                            <div class="comment-content-inner cci">
                                                                <span class="cci__author-info">{{ reply.writer }}</span>
                                                                <p class="cci__comment-text comment-content"> {{ reply.content }} </p>
                                                                <div class="cci__comment-actions">
                                                                    {% if user.is_authenticated and user == reply.writer %}
                                                                    <a href="#" class="btn-reply edit-comment ms-1" data-comment-id="{{ reply.id }}">
                                                                        <span>Edit</span>
                                                                    </a>
                                                                    <form action="{% url 'blogs:comment_delete' reply.pk %}" method="post" style="display: inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="btn-reply ms-1" style="background: none; border: none; color: inherit; font: inherit; padding: 0; cursor: pointer;">
                                                                            <span>Delete</span>
                                                                        </button>
                                                                    </form>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% empty %}
                                    <p> No comments yet! </p><br>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if messages %}
    <script>
        var errorMessages = "";
        {% for message in messages %}
            errorMessages += "{{ message }}\n";
        {% endfor %}
        alert(errorMessages);
    </script>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {  // (1) 문서가 준비되면 실행되는 코드
        // CSRF 토큰 설정
        function getCookie(name) {  // (2) 쿠키에서 CSRF 토큰을 가져오는 함수
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');  // (3) CSRF 토큰을 가져와 변수에 저장

        // 댓글 수정
        $('.edit-comment').click(function(e) {  // (4) .edit-comment 버튼 클릭 이벤트 핸들러
            e.preventDefault();
            var commentId = $(this).data('comment-id');  // (5) 댓글 ID를 가져옴
            var commentDiv = $('#comment-' + commentId);  // (6) 해당 댓글을 찾음
            var contentP = commentDiv.find('.comment-content');  // (7) 댓글 내용 요소를 찾음
            var content = contentP.text().trim();  // (8) 댓글 내용을 가져옴

            var form = $('<form>')  // (9) 댓글 수정 폼을 동적으로 생성
                .append($('<textarea>').addClass('form-control mb-2').val(content))
                .append($('<button>').addClass('btn btn-primary btn-sm mr-2').text('Save').click(function(e) {
                    e.preventDefault();
                    var newContent = $(this).siblings('textarea').val();  // (10) 수정된 내용을 가져옴

                    $.ajax({
                        url: '{% url "blogs:comment_update" 999999 %}'.replace('999999', commentId),  // (11) Ajax로 댓글 수정 요청을 보냄
                        method: 'POST',
                        data: {
                            'content': newContent,
                        },
                        headers: {'X-CSRFToken': csrftoken},  // (12) CSRF 토큰을 헤더에 추가
                        success: function(response) {  // (13) 성공 시, 댓글 내용을 갱신
                            contentP.text(response.content);
                            form.replaceWith(contentP);
                        },
                        error: function(xhr) {  // (14) 오류 발생 시, 경고 메시지 표시
                            alert(xhr.responseJSON.error || 'An error occurred while updating the comment.');
                        }
                    });
                }))
                .append($('<button>').addClass('btn btn-secondary btn-sm').text('Cancel').click(function(e) {  // (15) 취소 버튼을 추가
                    e.preventDefault();
                    form.replaceWith(contentP);  // (16) 폼을 댓글 내용으로 교체
                }));

            contentP.replaceWith(form);  // (17) 댓글 내용을 폼으로 교체
        });

        // 대댓글 작성
        $(document).on('click', '.reply-comment', function(e) {  // (18) .reply-comment 버튼 클릭 이벤트 핸들러 (이벤트 위임 사용)
            e.preventDefault();
            console.log("Reply button clicked!");
            var commentId = $(this).closest('.dm-comment-box__content').attr('id').split('-')[1];  // (19) 댓글 ID를 가져옴
            console.log("Comment ID: ", commentId);
            var existingForm = $('#reply-form-' + commentId);  // (20) 이미 존재하는 대댓글 폼이 있는지 확인
            console.log("Existing form: ", existingForm);

            if (existingForm.length) {  // (21) 대댓글 폼이 있으면 토글로 보여줌/숨김
                existingForm.remove();
            }

            var replyForm = $('<form>')  // (22) 대댓글 작성 폼을 동적으로 생성
                .attr('id', 'reply-form-' + commentId)
                .addClass('reply-form mt-2')
                .append($('<textarea>').addClass('form-control mb-2').attr('placeholder', 'Write your reply...'))
                .append($('<button>').addClass('btn btn-primary btn-sm mr-2').text('Submit').click(function(e) {
                    e.preventDefault();
                    var content = $(this).siblings('textarea').val();  // (23) 대댓글 내용을 가져옴
                    $.ajax({
                        url: '{% url "blogs:post_detail" post.pk %}',  // (24) Ajax로 대댓글 작성 요청을 보냄
                        method: 'POST',
                        data: {
                            'content': content,
                            'parent': commentId,  // (25) 부모 댓글 ID를 함께 전송
                        },
                        headers: {'X-CSRFToken': csrftoken},  // (26) CSRF 토큰을 헤더에 추가
                        success: function(response) {  // (27) 성공 시, 대댓글을 화면에 추가
                            // 페이지 새로고침
                            location.reload();  // 대댓글 작성 후 페이지를 새로고침
                        },
                        error: function(xhr) {  // (28) 오류 발생 시, 경고 메시지 표시
                            var errorMessage = "An error occurred while submitting the reply.";

                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            } else {
                                console.error("Error response:", xhr.responseText);  // 원래 서버 응답 확인
                            }

                            alert(errorMessage);  // 사용자에게 에러 메시지 표시
                        }
                    });

                }))
                .append($('<button>').addClass('btn btn-secondary btn-sm').text('Cancel').click(function(e) {  // (29) 취소 버튼을 추가
                    e.preventDefault();
                    replyForm.remove();  // (30) 폼을 제거
                }));

            $(this).after(replyForm);  // (31) 대댓글 폼을 버튼 아래에 추가
        });

    });

</script>
{% endblock  %}
